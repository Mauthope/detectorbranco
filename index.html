<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador de Objetos Brancos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #f0f0f0; font-family: Arial, sans-serif; }
        video { width: 80vw; height: auto; border: 2px solid #0077b6; border-radius: 8px; margin-bottom: 10px; }
        canvas { display: none; }
        #info { margin-top: 10px; text-align: center; }
        #boxes { margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center; }
        .dynamic-box { background-color: #0077b6; margin: 5px; border-radius: 8px; width: 50px; height: 50px; }
    </style>
</head>
<body>
    <video id="camera" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    <div id="info">
        <p>Objetos Brancos Detectados: <span id="contador-caixas">0</span></p>
    </div>
    <div id="boxes"></div>

    <script>
        const video = document.getElementById('camera');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const contadorCaixasElem = document.getElementById('contador-caixas');
        const boxesContainer = document.getElementById('boxes');

        let width, height;

        // Função para iniciar a câmera
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    width = video.videoWidth;
                    height = video.videoHeight;
                    canvas.width = width;
                    canvas.height = height;
                };
            } catch (err) {
                console.error("Erro ao acessar a câmera:", err);
            }
        }

        // Função para processar o quadro do vídeo e detectar objetos brancos
        function processFrame() {
            ctx.drawImage(video, 0, 0, width, height);
            let imageData = ctx.getImageData(0, 0, width, height);
            let data = imageData.data;

            // Aplicar saturação e converter para escala de cinza
            for (let i = 0; i < data.length; i += 4) {
                // Converter para tons de cinza (método luminosidade)
                const gray = 0.3 * data[i] + 0.59 * data[i + 1] + 0.11 * data[i + 2];
                
                // Aumentar contraste e saturação para realçar branco
                data[i] = data[i + 1] = data[i + 2] = gray > 200 ? 255 : 0; // Binário: 0 (preto) ou 255 (branco)
            }

            ctx.putImageData(imageData, 0, 0);

            // Detectar contornos e contar objetos
            const objectsCount = detectContours(imageData);
            contadorCaixasElem.textContent = objectsCount;
            updateBoxes(objectsCount);
        }

        // Função para detectar contornos usando um algoritmo simples
        function detectContours(imageData) {
            const data = imageData.data;
            let detected = new Set();
            let objects = 0;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const index = (y * width + x) * 4;
                    
                    // Se o pixel é branco e ainda não foi detectado
                    if (data[index] === 255 && !detected.has(index)) {
                        const size = floodFill(x, y, detected);
                        
                        // Contar apenas se o objeto for grande o suficiente
                        if (size > 200) { // Ajuste o valor conforme necessário
                            objects++;
                        }
                    }
                }
            }
            return objects;
        }

        // Função de Flood Fill para marcar um objeto
        function floodFill(x, y, detected) {
            const stack = [[x, y]];
            let size = 0;

            while (stack.length) {
                const [curX, curY] = stack.pop();
                const index = (curY * width + curX) * 4;

                if (curX < 0 || curY < 0 || curX >= width || curY >= height || detected.has(index)) continue;
                const pixelData = ctx.getImageData(curX, curY, 1, 1).data;
                if (pixelData[0] !== 255) continue;

                detected.add(index);
                size++;
                stack.push([curX + 1, curY], [curX - 1, curY], [curX, curY + 1], [curX, curY - 1]);
            }

            return size;
        }

        // Atualizar caixas na tela
        function updateBoxes(count) {
            boxesContainer.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const box = document.createElement('div');
                box.className = 'dynamic-box';
                boxesContainer.appendChild(box);
            }
        }

        function startDetection() {
            setInterval(processFrame, 300);
        }

        initCamera();
        video.addEventListener('play', startDetection);
    </script>
</body>
</html>
